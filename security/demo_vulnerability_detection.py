"""
Demo de detección de vulnerabilidades
Analiza archivos y muestra resultados detallados
"""

import sys
from pathlib import Path

# Add security folder to path
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from security.vulnerability_detector import (
    detect_vulnerabilities,
    format_vulnerability_report,
    get_vulnerability_summary,
    format_json_report
)


def analyze_file(filepath: Path, description: str = ""):
    """Analiza un archivo y muestra los resultados"""
    filename = str(filepath.name)
    
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            code = f.read()
        
        vulnerabilities = detect_vulnerabilities(code, filename)
        summary = get_vulnerability_summary(vulnerabilities)
        
        print(f"\n{'='*80}")
        print(f"FILE: {filename}")
        if description:
            print(f"Description: {description}")
        print('='*80)
        
        if summary['total'] > 0:
            print(f"\n[!] Found {summary['total']} vulnerabilities")
            print(f"    Highest Severity: {summary['highest_severity']}")
            print(f"    By severity: {summary['by_severity']}")
            print(f"    By type: {summary['by_type']}")
            print(format_vulnerability_report(vulnerabilities, filename))
        else:
            print("\n[+] No vulnerabilities detected - Code appears secure!")
        
        return {
            'file': filename,
            'description': description,
            'count': summary['total'],
            'summary': summary
        }
        
    except FileNotFoundError:
        print(f"\n[!] File not found: {filename}")
        return None
    except Exception as e:
        print(f"\n[ERROR] Error processing {filename}: {e}")
        return None


def analyze_directory(directory: Path, pattern: str = "*.py"):
    """Analiza todos los archivos en un directorio"""
    files = list(directory.rglob(pattern))
    
    if not files:
        print(f"[!] No files found matching pattern: {pattern}")
        return []
    
    results = []
    for filepath in files:
        result = analyze_file(filepath)
        if result:
            results.append(result)
    
    return results


def main():
    """Función principal del demo"""
    print("=" * 80)
    print("COMPREHENSIVE VULNERABILITY DETECTION DEMO")
    print("ChatEnTiempoRealV2 Security Scanner")
    print("=" * 80)
    
    # Ejemplos de archivos a analizar
    backend_path = PROJECT_ROOT / 'backend'
    
    test_files = [
        (backend_path / 'vulnerable_express.js', 'Express vulnerable test'),
        (backend_path / 'vulnerable_test.py', 'Python vulnerable test'),
        (backend_path / 'vulnerable_utils.py', 'Python utils vulnerable test'),
        (backend_path / 'server.js', 'Main server file'),
        (backend_path / 'socket.js', 'Socket.io handler'),
    ]
    
    total_files = 0
    total_vulnerabilities = 0
    results_summary = []
    
    for filepath, description in test_files:
        if not filepath.exists():
            continue
        
        result = analyze_file(filepath, description)
        if result:
            total_files += 1
            total_vulnerabilities += result['count']
            results_summary.append(result)
    
    # Analizar servicios de backend
    print(f"\n{'='*80}")
    print("ANALYZING BACKEND SERVICES")
    print('='*80)
    
    services_path = backend_path / 'services'
    if services_path.exists():
        service_results = analyze_directory(services_path, "*.js")
        total_files += len(service_results)
        total_vulnerabilities += sum(r['count'] for r in service_results)
        results_summary.extend(service_results)
    
    # Resumen final
    print("\n" + "="*80)
    print("FINAL SUMMARY")
    print("="*80)
    print(f"\nTotal files analyzed: {total_files}")
    print(f"Total vulnerabilities found: {total_vulnerabilities}")
    print("\nDetailed breakdown:")
    
    for result in results_summary:
        status = "[+] SECURE" if result['count'] == 0 else f"[!] {result['count']} issues"
        print(f"  {result['file']}: {status}")
        if result['count'] > 0 and result['summary']['highest_severity']:
            severity = result['summary']['highest_severity']
            print(f"     Highest Severity: {severity}")
            print(f"     By Severity: {result['summary']['by_severity']}")
    
    print("\n" + "="*80)
    
    # Retornar código de error si hay vulnerabilidades
    return 1 if total_vulnerabilities > 0 else 0


if __name__ == "__main__":
    sys.exit(main())
