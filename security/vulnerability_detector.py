"""
Comprehensive Vulnerability Detector
Detecta vulnerabilidades en cÃ³digo Python, JavaScript, TypeScript
con niveles de severidad, lÃ­neas exactas y reportes detallados
"""

import re
from enum import Enum
from typing import List, Dict, Any
from dataclasses import dataclass, field


class Severity(Enum):
    """Niveles de severidad de vulnerabilidades"""
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    INFO = "INFO"


class VulnerabilityType(Enum):
    """Tipos de vulnerabilidades"""
    SQL_INJECTION = "SQL Injection"
    XSS = "Cross-Site Scripting (XSS)"
    COMMAND_INJECTION = "Command Injection"
    PATH_TRAVERSAL = "Path Traversal"
    WEAK_CRYPTO = "Weak Cryptography"
    HARDCODED_SECRET = "Hardcoded Secret"
    UNSAFE_DESERIALIZATION = "Unsafe Deserialization"
    INSECURE_RANDOM = "Insecure Random"
    OPEN_REDIRECT = "Open Redirect"
    SSRF = "Server-Side Request Forgery"


@dataclass
class Vulnerability:
    """Representa una vulnerabilidad detectada"""
    type: VulnerabilityType
    severity: Severity
    line_number: int
    code_snippet: str
    description: str
    recommendation: str
    pattern: str = ""
    confidence: float = 1.0


class VulnerabilityPatterns:
    """Patrones de detecciÃ³n de vulnerabilidades por lenguaje"""
    
    PYTHON_PATTERNS = [
        # SQL Injection
        {
            'pattern': r'(cursor\.execute|execute)\s*\(\s*["\'].*%s.*["\'].*%',
            'type': VulnerabilityType.SQL_INJECTION,
            'severity': Severity.CRITICAL,
            'description': 'Uso de string formatting en queries SQL',
            'recommendation': 'Use parametrized queries: cursor.execute(query, (param,))',
            'confidence': 0.95
        },
        {
            'pattern': r'(cursor\.execute|execute)\s*\(\s*f["\']',
            'type': VulnerabilityType.SQL_INJECTION,
            'severity': Severity.CRITICAL,
            'description': 'Uso de f-strings en queries SQL',
            'recommendation': 'Use parametrized queries en lugar de f-strings',
            'confidence': 0.95
        },
        {
            'pattern': r'(cursor\.execute|execute)\s*\(\s*["\'].*\+.*["\']',
            'type': VulnerabilityType.SQL_INJECTION,
            'severity': Severity.CRITICAL,
            'description': 'ConcatenaciÃ³n de strings en queries SQL',
            'recommendation': 'Use parametrized queries en lugar de concatenaciÃ³n',
            'confidence': 0.90
        },
        
        # Command Injection
        {
            'pattern': r'os\.system\s*\(',
            'type': VulnerabilityType.COMMAND_INJECTION,
            'severity': Severity.CRITICAL,
            'description': 'Uso de os.system() con posible entrada de usuario',
            'recommendation': 'Use subprocess con argumentos separados: subprocess.run([cmd, arg1, arg2])',
            'confidence': 0.85
        },
        {
            'pattern': r'subprocess\.(call|Popen|run)\s*\([^,]*shell\s*=\s*True',
            'type': VulnerabilityType.COMMAND_INJECTION,
            'severity': Severity.HIGH,
            'description': 'Uso de subprocess con shell=True',
            'recommendation': 'Use subprocess sin shell=True y con lista de argumentos',
            'confidence': 0.90
        },
        {
            'pattern': r'eval\s*\(',
            'type': VulnerabilityType.COMMAND_INJECTION,
            'severity': Severity.CRITICAL,
            'description': 'Uso de eval() - puede ejecutar cÃ³digo arbitrario',
            'recommendation': 'Evite eval(). Use ast.literal_eval() para datos o alternativas seguras',
            'confidence': 0.95
        },
        {
            'pattern': r'exec\s*\(',
            'type': VulnerabilityType.COMMAND_INJECTION,
            'severity': Severity.CRITICAL,
            'description': 'Uso de exec() - puede ejecutar cÃ³digo arbitrario',
            'recommendation': 'Evite exec(). Refactorice el cÃ³digo para no necesitarlo',
            'confidence': 0.95
        },
        
        # Path Traversal
        {
            'pattern': r'open\s*\([^)]*\+',
            'type': VulnerabilityType.PATH_TRAVERSAL,
            'severity': Severity.HIGH,
            'description': 'Apertura de archivos con rutas concatenadas',
            'recommendation': 'Valide y sanitice rutas. Use os.path.join() y os.path.abspath()',
            'confidence': 0.75
        },
        
        # Weak Cryptography
        {
            'pattern': r'hashlib\.(md5|sha1)\s*\(',
            'type': VulnerabilityType.WEAK_CRYPTO,
            'severity': Severity.MEDIUM,
            'description': 'Uso de algoritmo de hash dÃ©bil (MD5/SHA1)',
            'recommendation': 'Use SHA-256 o superior: hashlib.sha256()',
            'confidence': 0.90
        },
        {
            'pattern': r'random\.(random|randint|choice)',
            'type': VulnerabilityType.INSECURE_RANDOM,
            'severity': Severity.MEDIUM,
            'description': 'Uso de generador de nÃºmeros aleatorios no criptogrÃ¡fico',
            'recommendation': 'Use secrets.token_bytes() o secrets.SystemRandom() para seguridad',
            'confidence': 0.80
        },
        
        # Unsafe Deserialization
        {
            'pattern': r'pickle\.(loads|load)\s*\(',
            'type': VulnerabilityType.UNSAFE_DESERIALIZATION,
            'severity': Severity.HIGH,
            'description': 'DeserializaciÃ³n con pickle - puede ejecutar cÃ³digo',
            'recommendation': 'Use JSON para datos no confiables, o firme/valide datos pickle',
            'confidence': 0.85
        },
        
        # Hardcoded Secrets
        {
            'pattern': r'(password|passwd|pwd|secret|token|api_key|apikey)\s*=\s*["\'][^"\']{8,}["\']',
            'type': VulnerabilityType.HARDCODED_SECRET,
            'severity': Severity.HIGH,
            'description': 'Posible secreto hardcodeado en cÃ³digo',
            'recommendation': 'Use variables de entorno o gestores de secretos',
            'confidence': 0.70
        },
    ]
    
    JAVASCRIPT_PATTERNS = [
        # XSS
        {
            'pattern': r'innerHTML\s*=',
            'type': VulnerabilityType.XSS,
            'severity': Severity.HIGH,
            'description': 'Uso de innerHTML - puede permitir XSS',
            'recommendation': 'Use textContent o sanitice HTML con DOMPurify',
            'confidence': 0.80
        },
        {
            'pattern': r'document\.write\s*\(',
            'type': VulnerabilityType.XSS,
            'severity': Severity.HIGH,
            'description': 'Uso de document.write() - puede permitir XSS',
            'recommendation': 'Use mÃ©todos modernos de DOM manipulation',
            'confidence': 0.85
        },
        {
            'pattern': r'dangerouslySetInnerHTML',
            'type': VulnerabilityType.XSS,
            'severity': Severity.HIGH,
            'description': 'Uso de dangerouslySetInnerHTML en React',
            'recommendation': 'Sanitice HTML con DOMPurify antes de usar',
            'confidence': 0.90
        },
        {
            'pattern': r'eval\s*\(',
            'type': VulnerabilityType.COMMAND_INJECTION,
            'severity': Severity.CRITICAL,
            'description': 'Uso de eval() - puede ejecutar cÃ³digo arbitrario',
            'recommendation': 'Evite eval(). Use JSON.parse() para datos o alternativas seguras',
            'confidence': 0.95
        },
        
        # Command Injection (Node.js)
        {
            'pattern': r'child_process\.(exec|spawn)\s*\(',
            'type': VulnerabilityType.COMMAND_INJECTION,
            'severity': Severity.HIGH,
            'description': 'EjecuciÃ³n de comandos del sistema',
            'recommendation': 'Valide y sanitice entradas. Use execFile() con argumentos separados',
            'confidence': 0.80
        },
        
        # Open Redirect
        {
            'pattern': r'window\.location\s*=\s*[^;]+request\.',
            'type': VulnerabilityType.OPEN_REDIRECT,
            'severity': Severity.MEDIUM,
            'description': 'RedirecciÃ³n con entrada de usuario sin validar',
            'recommendation': 'Valide URLs contra whitelist antes de redireccionar',
            'confidence': 0.75
        },
        
        # Hardcoded Secrets
        {
            'pattern': r'(password|passwd|pwd|secret|token|apiKey|api_key)\s*[:=]\s*["\'][^"\']{8,}["\']',
            'type': VulnerabilityType.HARDCODED_SECRET,
            'severity': Severity.HIGH,
            'description': 'Posible secreto hardcodeado en cÃ³digo',
            'recommendation': 'Use variables de entorno o gestores de secretos',
            'confidence': 0.70
        },
    ]
    
    @classmethod
    def get_patterns_for_language(cls, filename: str) -> List[Dict]:
        """Obtiene los patrones segÃºn el lenguaje del archivo"""
        ext = filename.split('.')[-1].lower()
        
        if ext in ['py']:
            return cls.PYTHON_PATTERNS
        elif ext in ['js', 'jsx', 'ts', 'tsx']:
            return cls.JAVASCRIPT_PATTERNS
        else:
            return []


def detect_vulnerabilities(code: str, filename: str) -> List[Vulnerability]:
    """
    Detecta vulnerabilidades en cÃ³digo
    
    Args:
        code: CÃ³digo fuente a analizar
        filename: Nombre del archivo (para determinar lenguaje)
    
    Returns:
        Lista de vulnerabilidades detectadas
    """
    vulnerabilities = []
    patterns = VulnerabilityPatterns.get_patterns_for_language(filename)
    
    lines = code.split('\n')
    
    for line_num, line in enumerate(lines, start=1):
        # Ignorar comentarios
        line_stripped = line.strip()
        if line_stripped.startswith('#') or line_stripped.startswith('//'):
            continue
        
        for pattern_info in patterns:
            pattern = pattern_info['pattern']
            
            if re.search(pattern, line, re.IGNORECASE):
                vuln = Vulnerability(
                    type=pattern_info['type'],
                    severity=pattern_info['severity'],
                    line_number=line_num,
                    code_snippet=line.strip(),
                    description=pattern_info['description'],
                    recommendation=pattern_info['recommendation'],
                    pattern=pattern,
                    confidence=pattern_info.get('confidence', 1.0)
                )
                vulnerabilities.append(vuln)
    
    return vulnerabilities


def get_vulnerability_summary(vulnerabilities: List[Vulnerability]) -> Dict[str, Any]:
    """
    Genera un resumen de las vulnerabilidades encontradas
    
    Args:
        vulnerabilities: Lista de vulnerabilidades
    
    Returns:
        Diccionario con resumen estadÃ­stico
    """
    if not vulnerabilities:
        return {
            'total': 0,
            'by_severity': {},
            'by_type': {},
            'highest_severity': None
        }
    
    by_severity = {}
    by_type = {}
    
    for vuln in vulnerabilities:
        # Contar por severidad
        severity_name = vuln.severity.value
        by_severity[severity_name] = by_severity.get(severity_name, 0) + 1
        
        # Contar por tipo
        type_name = vuln.type.value
        by_type[type_name] = by_type.get(type_name, 0) + 1
    
    # Determinar severidad mÃ¡s alta
    severity_order = [Severity.CRITICAL, Severity.HIGH, Severity.MEDIUM, Severity.LOW, Severity.INFO]
    highest_severity = None
    for sev in severity_order:
        if sev.value in by_severity:
            highest_severity = sev.value
            break
    
    return {
        'total': len(vulnerabilities),
        'by_severity': by_severity,
        'by_type': by_type,
        'highest_severity': highest_severity
    }


def format_vulnerability_report(vulnerabilities: List[Vulnerability], filename: str = "") -> str:
    """
    Formatea un reporte legible de vulnerabilidades
    
    Args:
        vulnerabilities: Lista de vulnerabilidades
        filename: Nombre del archivo (opcional)
    
    Returns:
        String con el reporte formateado
    """
    if not vulnerabilities:
        return "[+] No vulnerabilities detected!"
    
    report_lines = []
    
    if filename:
        report_lines.append(f"\nðŸ“ File: {filename}")
        report_lines.append("=" * 80)
    
    # Agrupar por severidad
    by_severity = {}
    for vuln in vulnerabilities:
        severity = vuln.severity.value
        if severity not in by_severity:
            by_severity[severity] = []
        by_severity[severity].append(vuln)
    
    # Reportar por orden de severidad
    severity_order = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO"]
    severity_icons = {
        "CRITICAL": "ðŸ”´",
        "HIGH": "ðŸŸ ",
        "MEDIUM": "ðŸŸ¡",
        "LOW": "ðŸ”µ",
        "INFO": "âšª"
    }
    
    for severity in severity_order:
        if severity not in by_severity:
            continue
        
        vulns = by_severity[severity]
        icon = severity_icons.get(severity, "âš«")
        
        report_lines.append(f"\n{icon} {severity} Severity ({len(vulns)} issues)")
        report_lines.append("-" * 80)
        
        for i, vuln in enumerate(vulns, 1):
            report_lines.append(f"\n  [{i}] {vuln.type.value}")
            report_lines.append(f"      Line {vuln.line_number}: {vuln.code_snippet[:100]}")
            report_lines.append(f"      Description: {vuln.description}")
            report_lines.append(f"      Recommendation: {vuln.recommendation}")
            report_lines.append(f"      Confidence: {vuln.confidence:.0%}")
    
    return "\n".join(report_lines)


def format_json_report(vulnerabilities: List[Vulnerability], filename: str = "") -> Dict[str, Any]:
    """
    Formatea un reporte JSON de vulnerabilidades
    
    Args:
        vulnerabilities: Lista de vulnerabilidades
        filename: Nombre del archivo (opcional)
    
    Returns:
        Diccionario con el reporte estructurado
    """
    summary = get_vulnerability_summary(vulnerabilities)
    
    vuln_list = []
    for vuln in vulnerabilities:
        vuln_list.append({
            'type': vuln.type.value,
            'severity': vuln.severity.value,
            'line': vuln.line_number,
            'code': vuln.code_snippet,
            'description': vuln.description,
            'recommendation': vuln.recommendation,
            'confidence': vuln.confidence
        })
    
    return {
        'file': filename,
        'summary': summary,
        'vulnerabilities': vuln_list
    }
